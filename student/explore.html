<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>دليل المدرّسين — طلابي</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{ color-scheme: dark }
    html,body{ background:#0b1220; color:#e5e7eb; font-family:system-ui,Segoe UI,Roboto,"Cairo","Noto Kufi Arabic",Arial,sans-serif }
    .glass{ background:rgba(255,255,255,.05); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,.08) }
  </style>
</head>
<body class="selection:bg-emerald-500/30">

  <header class="sticky top-0 z-30 glass">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-2xl bg-emerald-500/20 border border-emerald-400/30 grid place-content-center"><span class="text-emerald-300 font-bold">RHK</span></div>
      <h1 class="text-lg font-semibold">دليل المدرّسين</h1>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 grid gap-4">
    <!-- فلاتر -->
    <section class="glass rounded-2xl p-4">
      <div class="grid md:grid-cols-5 gap-2">
        <input id="qName" class="rounded-xl bg-white/5 border border-white/10 px-4 py-2" placeholder="بحث بالاسم/المادة">
        <input id="qCity" class="rounded-xl bg-white/5 border border-white/10 px-4 py-2" placeholder="المدينة">
        <input id="qArea" class="rounded-xl bg-white/5 border border-white/10 px-4 py-2" placeholder="المنطقة">
        <select id="qWeekday" class="rounded-xl bg-white/5 border border-white/10 px-3 py-2">
          <option value="">كل الأيام</option>
          <option value="0">الأحد</option><option value="1">الاثنين</option><option value="2">الثلاثاء</option>
          <option value="3">الأربعاء</option><option value="4">الخميس</option><option value="5">الجمعة</option><option value="6">السبت</option>
        </select>
        <button id="btnSearch" class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-white">تحديث</button>
      </div>
      <div id="err" class="text-rose-300 text-sm mt-2 hidden"></div>
    </section>

    <!-- قائمة المدرّسين -->
    <section id="list" class="grid gap-3"></section>
    <div id="no-results" class="hidden text-slate-400 p-4 glass rounded-xl">لا توجد نتائج</div>
  </main>

  <script>
    // Supabase
    const SUPABASE_URL  = "https://yxhezuscajteonrcpcms.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4aGV6dXNjYWp0ZW9ucmNwY21zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MTk4MjEsImV4cCI6MjA3NDQ5NTgyMX0.yHLhKPQ-Lu6e-cxzBo8_xsr6Gzr5ORKyKBgDCSTXukE";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const $ = s => document.querySelector(s);
    const wd = ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];
    const fmtHM = t => (t||'').slice(0,5);
    function showErr(m){ const e=$('#err'); e.textContent=m||''; e.classList.toggle('hidden', !m); }

    // جلب المدرّسين وفق الفلاتر
    async function fetchTeachers({q, city, area, weekday}){
      let q1 = client.from('teacher_public').select('*');
      if(q){ q1 = q1.or(`name.ilike.%${q}%,subject.ilike.%${q}%,bio_preview.ilike.%${q}%`); }
      if(city){ q1 = q1.eq('city', city); }
      if(area){ q1 = q1.eq('area', area); }
      q1 = q1.order('name', { ascending:true }).limit(200);

      const { data: teachers, error } = await q1;
      if(error) throw new Error(error.message);

      if(weekday==='' || weekday===undefined || weekday===null) return teachers;

      // فلترة المدرّسين اللي عندهم أوقات بهذا اليوم
      const ids = teachers.map(t=>t.teacher_id);
      if(!ids.length) return teachers;

      const { data: slots, error:e2 } = await client.from('slot_public_counts')
        .select('teacher_id,weekday')
        .in('teacher_id', ids)
        .eq('weekday', Number(weekday));
      if(e2) throw new Error(e2.message);

      const ok = new Set((slots||[]).map(s=>s.teacher_id));
      return teachers.filter(t => ok.has(t.teacher_id));
    }

    // جلب الأوقات لكل المدرّسين
    async function fetchSlotsByTeachers(ids){
      if(!ids.length) return [];
      const { data, error } = await client.from('slot_public_counts')
        .select('slot_id,teacher_id,title,weekday,start_time,end_time,capacity,current_count')
        .in('teacher_id', ids)
        .order('weekday',{ascending:true})
        .order('start_time',{ascending:true});
      if(error) throw new Error(error.message);
      return data||[];
    }

    // بطاقة مدرس (بدون تقييمات)
    function teacherBlock(t, slots){
      const ph = t.photo_url
        ? `<img src="${t.photo_url}" class="w-12 h-12 rounded-xl object-cover border border-white/10" />`
        : `<div class="w-12 h-12 rounded-xl grid place-content-center bg-white/5 border border-white/10">👨‍🏫</div>`;

      const rows = slots.length
        ? slots.map(sl=>{
            const fullCap = sl.current_count >= sl.capacity;
            return `
              <div class="flex items-center gap-3 p-2 rounded-lg bg-white/5 border border-white/10">
                <div class="w-12 h-12 grid place-content-center rounded-xl ${fullCap?'bg-rose-500/20 border border-rose-400/30':'bg-emerald-500/20 border border-emerald-400/30'}">
                  <span class="text-sm font-bold ${fullCap?'text-rose-300':'text-emerald-300'}">${sl.current_count}/${sl.capacity}</span>
                </div>
                <div class="mr-auto">
                  <div class="font-semibold">${sl.title}</div>
                  <div class="text-xs text-slate-400">${wd[sl.weekday]} • ${fmtHM(sl.start_time)}–${fmtHM(sl.end_time)}</div>
                </div>
              </div>`;
          }).join('')
        : `<div class="text-slate-400">لا توجد أوقات معلنة</div>`;

      const el = document.createElement('section');
      el.className = 'glass rounded-2xl p-4';
      el.innerHTML = `
        <div class="flex items-center gap-3">
          ${ph}
          <div class="mr-auto">
            <div class="font-semibold">${t.name} <span class="text-xs text-slate-400">(${t.subject||'—'})</span></div>
            <div class="text-xs text-slate-400">${t.city||''} ${t.area? '• '+t.area:''}</div>
            ${t.bio_preview ? `<div class="text-xs text-slate-400 mt-1">${t.bio_preview}</div>`:''}
          </div>
        </div>
        <div class="mt-3 grid md:grid-cols-2 lg:grid-cols-3 gap-2">
          ${rows}
        </div>
      `;
      return el;
    }

    async function run(){
      try{
        showErr('');
        $('#list').innerHTML = '<div class="text-slate-400 glass rounded-xl p-3">...</div>';
        $('#no-results').classList.add('hidden');

        const q = $('#qName').value.trim();
        const city = $('#qCity').value.trim();
        const area = $('#qArea').value.trim();
        const weekday = $('#qWeekday').value;

        const teachers = await fetchTeachers({ q, city, area, weekday });
        if(!teachers.length){
          $('#list').innerHTML = '';
          $('#no-results').classList.remove('hidden');
          return;
        }

        const ids = teachers.map(t=>t.teacher_id);
        const slots = await fetchSlotsByTeachers(ids);
        const slotsByTeacher = new Map();
        slots.forEach(s=>{
          if(!slotsByTeacher.has(s.teacher_id)) slotsByTeacher.set(s.teacher_id, []);
          slotsByTeacher.get(s.teacher_id).push(s);
        });

        const container = document.createDocumentFragment();
        teachers.forEach(t=>{
          const ts = (slotsByTeacher.get(t.teacher_id)||[]).sort((a,b)=>{
            if(a.weekday!==b.weekday) return a.weekday-b.weekday;
            return (a.start_time||'').localeCompare(b.start_time||'');
          });
          container.appendChild(teacherBlock(t, ts));
        });
        $('#list').innerHTML = '';
        $('#list').appendChild(container);
      }catch(err){
        console.error(err);
        showErr(err.message||String(err));
      }
    }

    $('#btnSearch').addEventListener('click', run);
    run();
  </script>

</body>
</html>
