<!doctype html>
<html lang="ar" dir="rtl">
<head >
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ù…Ù†ØµØ© Ø·Ù„Ø§Ø¨ÙŠ</title>
  <!-- Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙÙ‚Ø·. Ù„Ù„Ø¥Ù†ØªØ§Ø¬: Ø§Ø¨Ù†ÙŠ CSS Ù…Ø­Ù„ÙŠ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root { color-scheme: dark }
    html,body{ background:#0b1220 }
    .glass { background: rgba(255,255,255,.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,.08) }
    .drop-ok{ outline:2px dashed #22c55e; outline-offset: 4px }
    .dragging{ opacity:.6 }
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:60; }
    .modal.show{ display:flex; }
  </style>
  <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#10b981">

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="/icons/icon-192.png">

<script>
  // ØªØ³Ø¬ÙŠÙ„ SW
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
        .then(reg => {
          // Ù„Ùˆ Ù†Ø²Ù„ SW Ø¬Ø¯ÙŠØ¯ØŒ ÙØ¹Ù‘Ù„Ù‡ Ø¨Ø³Ø±Ø¹Ø©
          if (reg.waiting) reg.waiting.postMessage('SKIP_WAITING');
          reg.addEventListener('updatefound', () => {
            const nw = reg.installing;
            if (!nw) return;
            nw.addEventListener('statechange', () => {
              if (nw.state === 'installed' && navigator.serviceWorker.controller) {
                // SW Ø¬Ø¯ÙŠØ¯ Ø¬Ø§Ù‡Ø² â€” Ø±ÙŠÚ¤Ø±Ø´ Ø§Ø®ØªÙŠØ§Ø±ÙŠ
                // location.reload();
              }
            });
          });
        })
        .catch(console.error);
    });
  }
</script>

</head>
<body class="text-slate-100 selection:bg-emerald-500/30">
  <header class="sticky top-0 z-30 glass">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2 mr-auto">
        <div class="w-9 h-9 rounded-2xl bg-emerald-500/20 border border-emerald-400/30 grid place-content-center"><span class="text-emerald-300 font-bold">RHK</span></div>
        <h1 class="text-lg font-semibold" id="hdrTitle">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ù‘Ø³</h1>
      </div>
      <nav class="flex gap-2">
        <button id="tab-students" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10">Ø§Ù„Ø·Ù„Ø§Ø¨</button>
        <button id="tab-schedule" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10">Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©</button>
        <button id="tab-att" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
      </nav>
      <button id="logout" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10">Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <div id="warn" class="max-w-7xl mx-auto mt-4 px-4 hidden">
    <div class="glass rounded-xl p-3 border-amber-400/40 text-amber-200">Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ Ø£Ùˆ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ.</div>
  </div>

  <main class="max-w-7xl mx-auto p-4 grid gap-6">
    <!-- Ø§Ù„Ø·Ù„Ø§Ø¨ -->
    <section id="view-students" class="grid gap-4">
      <section class="glass rounded-2xl p-4">
        <h2 class="text-base font-semibold mb-3">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨</h2>
        <form id="student-form" class="grid md:grid-cols-5 gap-3">
          <input name="id" type="hidden" />
          <input name="name" class="rounded-xl bg-white/5 border border-white/10 px-4 py-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" required />
          <input name="phone" class="rounded-xl bg-white/5 border border-white/10 px-4 py-2" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" />
          <input name="plan_amount" type="number" step="0.01" min="0" class="rounded-xl bg-white/5 border border-white/10 px-4 py-2" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒØ§Ù…Ù„" required />
          <input name="paid_amount" type="number" step="0.01" min="0" class="rounded-xl bg-white/5 border border-white/10 px-4 py-2" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙˆØ§ØµÙ„" value="0" readonly />
          <div class="flex items-center gap-2 md:col-span-5">
            <button id="save-student" class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-white">Ø­ÙØ¸</button>
            <button id="reset-student" type="button" class="px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10">ØªÙØ±ÙŠØº</button>
            <span class="text-sm text-slate-300">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <b id="form-balance">0</b></span>
          </div>
        </form>
      </section>

      <div class="flex items-center gap-2">
        <input id="qStudents" class="rounded-xl bg-white/5 border border-white/10 px-4 py-2 w-full md:w-80" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ" />
        <button id="export-csv" class="px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10">ØªØµØ¯ÙŠØ± CSV</button>
      </div>

      <section class="glass rounded-2xl overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-white/5">
              <tr class="text-slate-300">
                <th class="px-4 py-3 border-b border-white/10 text-right">Ø§Ù„Ø§Ø³Ù…</th>
                <th class="px-4 py-3 border-b border-white/10 text-right">Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th class="px-4 py-3 border-b border-white/10 text-right">Ø§Ù„ÙƒØ§Ù…Ù„</th>
                <th class="px-4 py-3 border-b border-white/10 text-right">Ø§Ù„ÙˆØ§ØµÙ„</th>
                <th class="px-4 py-3 border-b border-white/10 text-right">Ø§Ù„Ø±ØµÙŠØ¯</th>
                <th class="px-4 py-3 border-b border-white/10 text-left">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="tbody-students">
              <tr><td class="px-4 py-4 text-slate-400" colspan="6">...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© -->
    <section id="view-schedule" class="grid gap-4 hidden">
      <section class="glass rounded-2xl p-4">
        <h2 class="text-base font-semibold mb-3">Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</h2>
        <form id="slot-form" class="grid md:grid-cols-8 gap-3">
          <input name="id" type="hidden"/>
          <input name="title" class="rounded-xl bg-white/5 border border-white/10 px-4 py-2 md:col-span-2" placeholder="Ø¹Ù†ÙˆØ§Ù† (Ù…Ø«Ù„Ø§Ù‹: Ø±ÙŠØ§Ø¶ÙŠØ§Øª A)"/>
          <select name="weekday" class="rounded-xl bg-white/5 border border-white/10 px-4 py-2">
            <option value="0">Ø§Ù„Ø£Ø­Ø¯</option><option value="1">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option value="2">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
            <option value="3">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option value="4">Ø§Ù„Ø®Ù…ÙŠØ³</option><option value="5">Ø§Ù„Ø¬Ù…Ø¹Ø©</option><option value="6">Ø§Ù„Ø³Ø¨Øª</option>
          </select>
          <input type="time" name="start_time" class="rounded-xl bg-white/5 border border-white/10 px-4 py-2" />
          <input type="time" name="end_time"   class="rounded-xl bg-white/5 border border-white/10 px-4 py-2" />
          <input type="number" name="capacity" min="1" value="25" class="rounded-xl bg-white/5 border border-white/10 px-4 py-2" placeholder="Ø§Ù„Ø³Ø¹Ø©" />
          <div class="flex items-center gap-2 md:col-span-8">
            <button id="save-slot" class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-white">Ø­ÙØ¸ Ø§Ù„ÙˆÙ‚Øª</button>
            <button type="button" id="copy-slot" class="px-4 py-2 rounded-xl bg-violet-500 hover:bg-violet-400 text-white">Ù†Ø³Ø® ÙƒÙˆÙ‚Øª Ø¬Ø¯ÙŠØ¯</button>
            <button type="button" id="reset-slot" class="px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10">ØªÙØ±ÙŠØº</button>
            <button type="button" id="auto-distribute" class="px-4 py-2 rounded-xl bg-sky-500 hover:bg-sky-400 text-white">ØªÙˆØ²ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
            <button type="button" id="clone-week" class="px-4 py-2 rounded-xl bg-amber-500 hover:bg-amber-400 text-white">Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
            <button type="button" id="enable-browser-notifs" class="px-4 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-400 text-white">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…ØªØµÙØ­</button>
            <span id="slot-hint" class="text-sm text-slate-400"></span>
          </div>
        </form>
      </section>

      <section class="glass rounded-2xl p-4">
        <h3 class="font-semibold mb-3">ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª</h3>
        <div id="slots-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
      </section>

      <section class="glass rounded-2xl p-4">
        <div class="flex items-center gap-3 mb-3">
          <h3 class="font-semibold">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª (Ø§Ø³Ø­Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©)</h3>
          <select id="dayFilter" class="rounded-xl bg-white/5 border border-white/10 px-3 py-2">
            <option value="all">ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù…</option>
            <option value="0">Ø§Ù„Ø£Ø­Ø¯</option><option value="1">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option value="2">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
            <option value="3">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option value="4">Ø§Ù„Ø®Ù…ÙŠØ³</option><option value="5">Ø§Ù„Ø¬Ù…Ø¹Ø©</option><option value="6">Ø§Ù„Ø³Ø¨Øª</option>
          </select>
          <input id="qBoard" class="ml-auto rounded-xl bg-white/5 border border-white/10 px-4 py-2 w-60" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù‡Ø§ØªÙ"/>
        </div>
        <div id="board" class="grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
      </section>
    </section>

    <!-- Ø§Ù„Ø­Ø¶ÙˆØ± -->
    <section id="view-att" class="grid gap-4 hidden">
      <section class="glass rounded-2xl p-4">
        <h2 class="text-base font-semibold mb-3">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
        <div class="grid md:grid-cols-4 gap-3 items-end">
          <div>
            <label class="text-sm text-slate-300">ØªØ§Ø±ÙŠØ®</label>
            <input id="att-date" type="date" class="w-full rounded-xl bg-white/5 border border-white/10 px-4 py-2">
          </div>
          <div class="md:col-span-2">
            <label class="text-sm text-slate-300">Ø§Ù„ÙˆÙ‚Øª (Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…)</label>
            <select id="att-slot" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2"></select>
          </div>
          <button id="att-load" class="px-4 py-2 rounded-xl bg-sky-500 hover:bg-sky-400 text-white">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
        </div>
      </section>

      <section class="glass rounded-2xl p-4">
        <div class="flex items-center mb-3">
          <h3 class="font-semibold">Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
          <button id="att-save" class="ml-auto px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-white">Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-white/5">
              <tr class="text-slate-300">
                <th class="px-4 py-3 border-b border-white/10 text-right">Ø§Ù„Ø§Ø³Ù…</th>
                <th class="px-4 py-3 border-b border-white/10 text-right">Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th class="px-4 py-3 border-b border-white/10 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th class="px-4 py-3 border-b border-white/10 text-left">Ù…Ù„Ø§Ø­Ø¸Ø©</th>
              </tr>
            </thead>
            <tbody id="att-body">
              <tr><td class="px-4 py-4 text-slate-400" colspan="4">Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø«Ù… "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨"</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </section>
  </main>

  <div class="fixed bottom-0 right-0 left-0 glass py-3 text-center text-sm text-slate-400 z-30">
    by <span class="text-emerald-400 font-semibold">rhk</span> â€” <a href="tel:07711918993" class="hover:text-emerald-300">07711918993</a>
  </div>

  <div id="toast" class="fixed bottom-20 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="glass rounded-xl px-4 py-2 text-sm shadow-lg">ØªÙ… âœ…</div>
  </div>

  <!-- Modal: Ø¯ÙØ¹Ø§Øª -->
  <div id="pay-modal" class="modal">
    <div class="glass rounded-2xl p-4 w-[520px] max-w-[95vw]">
      <div class="flex items-center mb-3">
        <h3 class="font-semibold">Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© â€” <span id="pay-student-name" class="text-emerald-300"></span></h3>
        <button id="pay-close" class="ml-auto px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <form id="pay-form" class="grid md:grid-cols-2 gap-3">
        <input type="hidden" name="student_id">
        <div><label class="text-sm text-slate-300">Ø§Ù„Ù…Ø¨Ù„Øº</label><input name="amount" type="number" step="0.01" min="0" class="w-full rounded-xl bg-white/5 border border-white/10 px-4 py-2" required></div>
        <div><label class="text-sm text-slate-300">Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª</label><input name="paid_at" type="datetime-local" class="w-full rounded-xl bg-white/5 border border-white/10 px-4 py-2"></div>
        <div><label class="text-sm text-slate-300">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</label>
          <select name="method" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2">
            <option value="">â€”</option><option value="cash">Ù†Ù‚Ø¯</option><option value="zaincash">ZainCash</option><option value="asiahawala">Ø¢Ø³ÙŠØ§ Ø­ÙˆØ§Ù„Ø©</option><option value="card">Ø¨Ø·Ø§Ù‚Ø©</option>
          </select></div>
        <div class="md:col-span-2"><label class="text-sm text-slate-300">Ù…Ù„Ø§Ø­Ø¸Ø©</label><input name="note" class="w-full rounded-xl bg-white/5 border border-white/10 px-4 py-2" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
        <div class="md:col-span-2 flex items-center gap-2">
          <button id="pay-save" class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-white">Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©</button>
          <span id="pay-info" class="text-sm text-slate-400"></span>
        </div>
      </form>
      <div class="mt-4">
        <div class="text-sm text-slate-300 mb-2">Ø¢Ø®Ø± Ø§Ù„Ø¯ÙØ¹Ø§Øª</div>
        <div id="pay-list" class="space-y-2 max-h-56 overflow-auto"></div>
      </div>
    </div>
  </div>

<!-- Modal: ØªØ°ÙƒÙŠØ± (Ù†Ø³Ø®Ø© Ù…ØµØºÙ‘Ø±Ø©) -->
<div id="rem-modal" class="modal">
  <div class="glass rounded-xl p-3 w-[420px] max-w-[95vw] relative text-sm">
    <div class="flex items-center mb-2">
      <h3 class="font-semibold text-base">ğŸ”” ØªØ°ÙƒÙŠØ± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</h3>
      <button id="rem-x" class="ml-2 px-2 py-1 text-xs rounded-lg bg-white/5 hover:bg-white/10 border border-white/10">Ã—</button>
      <button id="rem-close" class="ml-auto px-2.5 py-1.5 text-xs rounded-lg bg-white/5 hover:bg-white/10 border border-white/10">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div class="space-y-2">
      <div class="text-xs text-slate-300">Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø§Ù‡Ø²:</div>
      <textarea id="rem-text" class="w-full h-20 rounded-lg bg-white/5 border border-white/10 px-2.5 py-2 text-sm"></textarea>

      <div class="flex items-center gap-2">
        <label class="flex items-center gap-2 text-xs text-slate-300">
          <input id="rem-today-only" type="checkbox" class="rounded" checked>
          Ø¥Ø±Ø³Ø§Ù„ Ù„Ø·Ù„Ø§Ø¨ <b>Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·</b>
        </label>
        <span id="rem-day-note" class="text-[11px] text-slate-400"></span>
      </div>

      <div class="flex gap-2">
        <button id="rem-copy" class="px-2.5 py-1.5 text-xs rounded-lg bg-emerald-500 hover:bg-emerald-400 text-white">Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
        <button id="rem-open-all-wa" class="px-2.5 py-1.5 text-xs rounded-lg bg-sky-500 hover:bg-sky-400 text-white">ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†</button>
      </div>

      <div class="text-xs text-slate-300">Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø© (Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª ÙÙ‚Ø·):</div>
      <div id="rem-links" class="grid grid-cols-1 gap-2 max-h-48 overflow-auto pr-1"></div>

      <div class="flex justify-end pt-1">
        <button id="rem-close-bottom" class="px-2.5 py-1.5 text-xs rounded-lg bg-white/5 hover:bg-white/10 border border-white/10">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>
</div>


<script>
/* ===== Supabase ===== */
const client = supabase.createClient(
  "https://yxhezuscajteonrcpcms.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4aGV6dXNjYWp0ZW9ucmNwY21zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MTk4MjEsImV4cCI6MjA3NDQ5NTgyMX0.yHLhKPQ-Lu6e-cxzBo8_xsr6Gzr5ORKyKBgDCSTXukE"
);

client.auth.onAuthStateChange((_, session) => { if (session?.access_token) client.realtime.setAuth(session.access_token); });
async function ensureRealtimeAuth(){ const { data:{ session } } = await client.auth.getSession(); if (session?.access_token) client.realtime.setAuth(session.access_token); }

/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function toast(msg='ØªÙ… âœ…'){ const t=$('#toast'); t.querySelector('div').textContent=msg; t.classList.remove('hidden'); clearTimeout(t._timer); t._timer=setTimeout(()=>t.classList.add('hidden'),1400); }
function money(n){ return Number(n||0).toLocaleString('ar-IQ',{minimumFractionDigits:2, maximumFractionDigits:2}); }
function wdName(n){ return ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'][Number(n)||0]; }
function fmtHM(t){ return t?.slice(0,5) || '' }
function nextDateForWeekday(wd){ const now=new Date(); const diff=((wd-now.getDay())+7)%7; return new Date(now.getFullYear(), now.getMonth(), now.getDate()+diff, 0,0,0,0); }
function normalizeIQ(phone){
  if(!phone) return '';
  const digits = phone.replace(/\D+/g,'');
  if(digits.startsWith('964')) return digits;
  if(digits.startsWith('0')) return '964' + digits.slice(1);
  return digits;
}
$('#logout').onclick = async ()=>{ await client.auth.signOut(); location.href='./index.html'; };

/* ===== Guard ===== */
async function guard(){
  const { data:{ user } } = await client.auth.getUser();
  if(!user){ location.href='./index.html'; return null; }
  const { data: profile } = await client.from('profiles').select('role').eq('id', user.id).single();
  const role = profile?.role || 'teacher';
  if (role==='admin') {
    const badge=document.createElement('span');
    badge.className='ml-2 text-xs px-2 py-1 rounded bg-emerald-500/20 border border-emerald-400/30 text-emerald-300';
    badge.textContent='Admin';
    document.getElementById('hdrTitle').appendChild(badge);
  } else {
    const nowIso = new Date().toISOString();
    const { count } = await client.from('subscriptions').select('id',{head:true,count:'exact'})
      .eq('user_id', user.id).eq('active', true).lte('starts_at', nowIso).gte('ends_at', nowIso);
    if(!count) $('#warn').classList.remove('hidden'); else $('#warn').classList.add('hidden');
  }
  return user;
}

/* ===== Tabs ===== */
const viewStudents=$('#view-students'), viewSchedule=$('#view-schedule'), viewAtt=$('#view-att');
function showTab(k){
  viewStudents.classList.toggle('hidden', k!=='students');
  viewSchedule.classList.toggle('hidden', k!=='schedule');
  viewAtt.classList.toggle('hidden', k!=='att');
  if(k==='schedule'){ $('#qBoard').value=''; refreshBoard(); }
}
$('#tab-students').onclick = ()=> showTab('students');
$('#tab-schedule').onclick = ()=> showTab('schedule');
$('#tab-att').onclick = ()=> showTab('att');

/* ===== Ø§Ù„Ø·Ù„Ø§Ø¨ ===== */
const sForm = $('#student-form'), tbody = $('#tbody-students');
function sFormGet(){ const fd=new FormData(sForm); return { id:fd.get('id')||null, name:(fd.get('name')||'').trim(), phone:(fd.get('phone')||'').trim()||null, plan_amount:Number(fd.get('plan_amount')||0), paid_amount:Number(fd.get('paid_amount')||0) }; }
function sFormSet(x){
  sForm.elements.id.value = x?.id || '';
  sForm.elements.name.value = x?.name || '';
  sForm.elements.phone.value = x?.phone || '';
  sForm.elements.plan_amount.value = x?.plan_amount ?? '';
  sForm.elements.paid_amount.value = x?.paid_amount ?? 0;
  const bal = (Number(sForm.elements.plan_amount.value||0)-Number(sForm.elements.paid_amount.value||0)).toFixed(2);
  $('#form-balance').textContent = bal;
}
$('#reset-student').onclick = ()=> sFormSet(null);
sForm.elements.plan_amount.oninput = ()=> $('#form-balance').textContent = (Number(sForm.elements.plan_amount.value||0)-Number(sForm.elements.paid_amount.value||0)).toFixed(2);

$('#save-student').onclick = async (e)=>{
  e.preventDefault();
  const { data:{ user } } = await client.auth.getUser();
  const v = sFormGet();
  if(!v.name) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨'); if(v.plan_amount < 0) return alert('Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒØ§Ù…Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬Ø¨Ù‹Ø§');

  if(!v.id){
    const payload = { name:v.name, phone:v.phone, plan_amount:v.plan_amount, paid_amount:v.paid_amount, created_by: user.id };
    const { error } = await client.from('students').insert(payload);
    if(error) return alert(error.message); toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨');
  } else {
    const { error } = await client.from('students').update({ name:v.name, phone:v.phone, plan_amount:v.plan_amount }).eq('id', Number(v.id));
    if(error) return alert(error.message); toast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ø§Ù„Ø¨');
  }
  sFormSet(null); await loadStudents(); await refreshBoard();
};

async function loadStudents(filter=''){
  tbody.innerHTML = `<tr><td class="px-4 py-4 text-slate-400" colspan="6">...</td></tr>`;
  const base = client.from('students').select('id,name,phone,plan_amount,paid_amount').order('id',{ascending:false});
  const { data, error } = filter ? await base.or(`name.ilike.%${filter}%,phone.ilike.%${filter}%`) : await base;
  if(error){ tbody.innerHTML = `<tr><td class="px-4 py-4 text-rose-300" colspan="6">${error.message}</td></tr>`; return; }
  const rows = (data||[]).map(s=>({...s, balance:Number(s.plan_amount)-Number(s.paid_amount)}));
  if(!rows.length){ tbody.innerHTML = `<tr><td class="px-4 py-6 text-slate-400" colspan="6">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</td></tr>`; return; }
  tbody.innerHTML=''; rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="px-4 py-3 border-b border-white/10 font-medium">${r.name}</td>
      <td class="px-4 py-3 border-b border-white/10 text-slate-300">${r.phone||''}</td>
      <td class="px-4 py-3 border-b border-white/10 text-emerald-300">${money(r.plan_amount)}</td>
      <td class="px-4 py-3 border-b border-white/10 text-sky-300">${money(r.paid_amount)}</td>
      <td class="px-4 py-3 border-b border-white/10 ${r.balance>0?'text-amber-300':'text-emerald-300'}">${money(r.balance)}</td>
      <td class="px-4 py-3 border-b border-white/10 text-left">
        <div class="flex gap-2 justify-end">
          <button class="px-3 py-1.5 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-white" data-pay="${r.id}" data-name="${r.name}">Ø¯ÙØ¹Ø©</button>
          <button class="px-3 py-1.5 rounded-lg bg-sky-500 hover:bg-sky-400 text-white" data-edit="${r.id}">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="px-3 py-1.5 rounded-lg bg-rose-500 hover:bg-rose-400 text-white" data-del="${r.id}">Ø­Ø°Ù</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('[data-edit]').forEach(b=> b.onclick = async ()=>{
    const id=Number(b.dataset.edit);
    const { data, error } = await client.from('students').select('*').eq('id', id).single();
    if(error) return alert(error.message); sFormSet(data); window.scrollTo({top:0,behavior:'smooth'}); showTab('students');
  });
  tbody.querySelectorAll('[data-del]').forEach(b=> b.onclick = async ()=>{
    const id=Number(b.dataset.del); if(!confirm('Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) return;
    const { error } = await client.from('students').delete().eq('id', id);
    if(error) return alert(error.message); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù'); await loadStudents($('#qStudents').value.trim()); await refreshBoard();
  });
  tbody.querySelectorAll('[data-pay]').forEach(b=> b.onclick = ()=> openPayment(Number(b.dataset.pay), b.dataset.name));
}
$('#qStudents').oninput = ()=>{ const q=$('#qStudents'); clearTimeout(q._t); q._t=setTimeout(()=>loadStudents(q.value.trim()), 220); };
$('#export-csv').onclick = async ()=>{
  const { data } = await client.from('students').select('*').order('id',{ascending:true});
  const headers = data?.[0]? Object.keys(data[0]) : [];
  const esc = v=>`"${String(v??'').replace(/"/g,'""')}"`;
  const csv = [headers.join(',')].concat((data||[]).map(r=>headers.map(h=>esc(r[h])).join(','))).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`students_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(url);
  toast('ØªÙ… ØªØµØ¯ÙŠØ± CSV');
};

/* ===== Modal: Payments ===== */
const payModal = $('#pay-modal'), payForm = $('#pay-form'), payList = $('#pay-list'), payInfo = $('#pay-info');
$('#pay-close').onclick = ()=> payModal.classList.remove('show');

function openPayment(studentId, name){
  payForm.reset();
  payForm.elements.student_id.value = studentId;
  $('#pay-student-name').textContent = name;
  const dt = new Date();
  payForm.elements.paid_at.value = new Date(dt.getTime()-dt.getTimezoneOffset()*60000).toISOString().slice(0,16);
  payInfo.textContent = '';
  payModal.classList.add('show');
  loadPayments(studentId);
}
async function loadPayments(studentId){
  payList.innerHTML = '<div class="text-slate-400">...</div>';
  const { data, error } = await client.from('payments').select('id,amount,paid_at,method,note').eq('student_id', studentId).order('paid_at',{ascending:false}).limit(50);
  if (error) { payList.innerHTML = `<div class="text-rose-300">${error.message}</div>`; return; }
  if (!data?.length) { payList.innerHTML = `<div class="text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª</div>`; return; }
  payList.innerHTML = '';
  data.forEach(p=>{
    const div=document.createElement('div');
    div.className='glass rounded-xl px-3 py-2 flex items-center gap-3';
    const d = new Date(p.paid_at);
    div.innerHTML = `
      <div class="text-emerald-300 font-semibold">${money(p.amount)}</div>
      <div class="text-slate-300 text-sm mr-auto">${d.toLocaleDateString('ar-IQ')} ${d.toLocaleTimeString('ar-IQ',{hour:'2-digit',minute:'2-digit'})}</div>
      <div class="text-xs text-slate-400">${p.method||''}</div>
      ${p.note?`<div class="text-xs text-slate-400">â€” ${p.note}</div>`:''}
      <button class="px-2 py-1 text-xs rounded bg-rose-500 hover:bg-rose-400 text-white" data-delpay="${p.id}">Ø­Ø°Ù</button>
    `;
    payList.appendChild(div);
  });
  payList.querySelectorAll('[data-delpay]').forEach(b=> b.onclick = ()=> deletePayment(Number(b.dataset.delpay)));
}
async function deletePayment(id){
  if(!confirm('Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©ØŸ')) return;
  const { error } = await client.from('payments').delete().eq('id', id);
  if (error) return alert(error.message);
  toast('Ø­ÙØ°ÙØª Ø§Ù„Ø¯ÙØ¹Ø©');
  const sid = Number(payForm.elements.student_id.value);
  await loadPayments(sid);
  await loadStudents($('#qStudents').value.trim());
}
$('#pay-save').onclick = async (e)=>{
  e.preventDefault();
  const fd = new FormData(payForm);
  const student_id = Number(fd.get('student_id'));
  const amount = Number(fd.get('amount')||0);
  const paid_at = fd.get('paid_at') ? new Date(fd.get('paid_at')).toISOString() : new Date().toISOString();
  const method = fd.get('method') || null;
  const note = (fd.get('note')||'').trim() || null;
  if(!(student_id>0) || !(amount>0)) return alert('ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„');

  const { data:{ user } } = await client.auth.getUser();
  const { error } = await client.from('payments').insert({ student_id, amount, paid_at, method, note, created_by: user.id });
  if (error) return alert(error.message);

  const { data: st } = await client.from('students').select('plan_amount,paid_amount,name,phone,id').eq('id', student_id).single();
  const remaining = (Number(st?.plan_amount||0) - Number(st?.paid_amount||0)).toFixed(2);
  $('#pay-info').textContent = `Ø§Ù„ÙˆØ§ØµÙ„: ${money(st?.paid_amount||0)} | Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${money(remaining)}`;
  if (String(sForm.elements.id.value||'') === String(student_id)) {
    sFormSet({ id: st.id, name: st.name, phone: st.phone, plan_amount: st.plan_amount, paid_amount: st.paid_amount });
  }
  await loadPayments(student_id);
  await loadStudents($('#qStudents').value.trim());
  toast('Ø§Ù†Ø­ÙØ¸Øª Ø§Ù„Ø¯ÙØ¹Ø© âœ”ï¸');
};

/* ===== Ø§Ù„Ø£ÙˆÙ‚Ø§Øª + ØªØ°ÙƒÙŠØ± ===== */
const slotForm = $('#slot-form'), slotsList=$('#slots-list');
function slotFormGet(){ const fd=new FormData(slotForm); return { id:fd.get('id')||null, title:(fd.get('title')||'').trim(), weekday:Number(fd.get('weekday')), start_time:fd.get('start_time'), end_time:fd.get('end_time'), capacity:Number(fd.get('capacity')||25) }; }
function slotFormSet(x){
  slotForm.elements.id.value = x?.id || '';
  slotForm.elements.title.value = x?.title || '';
  slotForm.elements.weekday.value = x?.weekday ?? 0;
  slotForm.elements.start_time.value = x?.start_time || '';
  slotForm.elements.end_time.value = x?.end_time || '';
  slotForm.elements.capacity.value = x?.capacity ?? 25;
}
$('#reset-slot').onclick = ()=> slotFormSet(null);

$('#save-slot').onclick = async (e)=>{
  e.preventDefault();
  const { data:{ user } } = await client.auth.getUser();
  const v = slotFormGet();
  if(!v.title) return alert('Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆÙ‚Øª');
  if(!v.start_time || !v.end_time) return alert('Ø­Ø¯Ù‘Ø¯ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©');
  if(v.capacity<=0) return alert('Ø§Ù„Ø³Ø¹Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…ÙˆØ¬Ø¨Ø©');

  if(!v.id){
    const payload = { ...v, created_by: user.id }; delete payload.id;
    const { error } = await client.from('slots').insert(payload);
    if(error) return alert(error.message); toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙ‚Øª');
  } else {
    const { data: oldSlot, error: oldErr } = await client.from('slots').select('weekday,start_time,end_time,capacity').eq('id', Number(v.id)).single();
    if (oldErr) return alert(oldErr.message);
    const timeChanged = (oldSlot.start_time!==v.start_time) || (oldSlot.end_time!==v.end_time);

    const { count, error: cErr } = await client.from('student_slots').select('id',{head:true,count:'exact'}).eq('slot_id', Number(v.id));
    if(!cErr && count > v.capacity) return alert(`Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (${v.capacity}) Ø£Ù‚Ù„ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ (${count}).`);

    const { error } = await client.from('slots').update({ title:v.title, weekday:v.weekday, start_time:v.start_time, end_time:v.end_time, capacity:v.capacity }).eq('id', Number(v.id));
    if(error) return alert(error.message);

    if (timeChanged) {
      const { error: delErr } = await client.from('student_slots').delete().eq('slot_id', Number(v.id));
      if (delErr) console.warn('Delete assigns blocked (RLS?)', delErr.message);
    }
    toast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª');
  }
  slotFormSet(null); await refreshSlots(); await refreshBoard();
};

$('#copy-slot').onclick = async (e)=>{
  e.preventDefault();
  const { data:{ user } } = await client.auth.getUser();
  const v = slotFormGet();
  if(!v.title || !v.start_time || !v.end_time) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„');
  const payload = { title:v.title, weekday:v.weekday, start_time:v.start_time, end_time:v.end_time, capacity:v.capacity, created_by: user.id };
  const { error } = await client.from('slots').insert(payload);
  if (error) return alert(error.message);
  toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆÙ‚Øª Ø¬Ø¯ÙŠØ¯ (Ù†Ø³Ø®Ø©)'); await refreshSlots(); await refreshBoard();
};

$('#clone-week').onclick = async ()=>{
  const { data:{ user } } = await client.auth.getUser();
  const { data: slots } = await client.from('slots').select('title,weekday,start_time,end_time,capacity').order('weekday');
  if(!slots?.length) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙˆÙ‚Ø§Øª Ù„Ø§Ø³ØªÙ†Ø³Ø§Ø®Ù‡Ø§');
  const rows = slots.map(s=>({ ...s, title: `${s.title} (Ù†Ø³Ø®Ø©)`, created_by: user.id }));
  const { error } = await client.from('slots').insert(rows);
  if (error) return alert(error.message);
  toast(`ØªÙ… Ø§Ø³ØªÙ†Ø³Ø§Ø® ${rows.length} ÙˆÙ‚Øª`);
  await refreshSlots(); await refreshBoard();
};

async function refreshSlots(){
  const { data: slots, error: slotErr } = await client.from('slots').select('id,title,weekday,start_time,end_time,capacity').order('weekday', { ascending: true });
  if (slotErr){ slotsList.innerHTML = `<div class="text-rose-300">${slotErr.message}</div>`; return; }

  const { data: ss } = await client.from('student_slots').select('slot_id');
  const countMap = {};
  (ss||[]).forEach(r=>{ countMap[r.slot_id]=(countMap[r.slot_id]||0)+1; });

  slotsList.innerHTML='';
  (slots||[]).forEach(sl=>{
    const filled=countMap[sl.id]||0;
    const full = filled>=sl.capacity;
    const card=document.createElement('div');
    card.className='glass rounded-xl p-3 flex items-center gap-3';
    card.innerHTML=`
      <div class="w-12 h-12 grid place-content-center rounded-xl ${full?'bg-rose-500/20 border-rose-400/30':'bg-emerald-500/20 border-emerald-400/30'} border">
        <span class="text-sm font-bold ${full?'text-rose-300':'text-emerald-300'}">${filled}/${sl.capacity}</span>
      </div>
      <div class="mr-auto">
        <div class="font-semibold">${sl.title} <span class="text-xs text-slate-400">(#${sl.id})</span></div>
        <div class="text-slate-400 text-xs">${wdName(sl.weekday)} â€¢ ${fmtHM(sl.start_time)}â€“${fmtHM(sl.end_time)}</div>
      </div>
      <div class="flex gap-2">
        <button class="px-3 py-1.5 rounded-lg bg-sky-500 hover:bg-sky-400 text-white" data-edit-slot="${sl.id}">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="px-3 py-1.5 rounded-lg bg-rose-500 hover:bg-rose-400 text-white" data-del-slot="${sl.id}">Ø­Ø°Ù</button>
        <button class="px-3 py-1.5 rounded-lg bg-indigo-500 hover:bg-indigo-400 text-white" title="ØªØ°ÙƒÙŠØ±" data-rem="${sl.id}">ğŸ””</button>
      </div>`;
    slotsList.appendChild(card);
  });
  slotsList.querySelectorAll('[data-edit-slot]').forEach(b=> b.onclick = ()=> handleEditSlot(Number(b.dataset.editSlot)));
  slotsList.querySelectorAll('[data-del-slot]').forEach(b=> b.onclick = ()=> handleDeleteSlot(Number(b.dataset.delSlot)));
  slotsList.querySelectorAll('[data-rem]').forEach(b=> b.onclick = ()=> openReminder(Number(b.dataset.rem)));
  $('#slot-hint').textContent = `ØºÙŠØ± Ù…ÙˆØ²Ù‘Ø¹ÙŠÙ†: ${await getUnassignedCount()}`;
}

async function handleEditSlot(id){
  const { data, error } = await client.from('slots').select('*').eq('id', id).single();
  if(error) return alert(error.message);
  slotFormSet(data); window.scrollTo({ top: 0, behavior: 'smooth' }); showTab('schedule');
}
async function handleDeleteSlot(id){
  const { count } = await client.from('student_slots').select('id', { head:true, count:'exact' }).eq('slot_id', id);
  if(!confirm(`ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ${count?'\nØªÙ†Ø¨ÙŠÙ‡: ÙŠÙˆØ¬Ø¯ '+count+' Ø·Ø§Ù„Ø¨ Ù…Ø±ØªØ¨Ø·':''}`)) return;
  const { error } = await client.from('slots').delete().eq('id', id);
  if(error) return alert(error.message);
  toast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆÙ‚Øª'); await refreshSlots(); await refreshBoard();
}
async function getUnassignedCount(){
  const { data: stu } = await client.from('students').select('id');
  const { data: ss }  = await client.from('student_slots').select('student_id');
  const assigned = new Set((ss||[]).map(x=>x.student_id));
  return (stu||[]).filter(s=>!assigned.has(s.id)).length;
}

/* ===== Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø­Ø¨/Ø§Ù„Ø¥ÙÙ„Ø§Øª ===== */
const board = $('#board'); let cache = { students:[], slots:[], assigns:[] };
const boardSearch=$('#qBoard'); const dayFilterEl = $('#dayFilter'); let boardDayFilter = 'all';
dayFilterEl.onchange = ()=>{ boardDayFilter = dayFilterEl.value; renderBoard(boardSearch.value); };
boardSearch.oninput = ()=>{ clearTimeout(boardSearch._t); boardSearch._t=setTimeout(()=>renderBoard(boardSearch.value), 200); };

async function loadBoardData(){
  const [ S, SL, SS ] = await Promise.all([
    client.from('students').select('id,name,phone').order('id',{ascending:false}),
    client.from('slots').select('id,title,weekday,start_time,end_time,capacity').order('weekday',{ascending:true}),
    client.from('student_slots').select('student_id,slot_id')
  ]);
  if (S.error)  console.error('students load error:', S.error?.message);
  if (SL.error) console.error('slots load error:', SL.error?.message);
  if (SS.error) console.error('student_slots load error:', SS.error?.message);
  cache.students = Array.isArray(S.data)  ? S.data  : [];
  cache.slots    = Array.isArray(SL.data) ? SL.data : [];
  cache.assigns  = Array.isArray(SS.data) ? SS.data : [];
}

function renderBoard(filter=''){
  const q=(filter||'').trim().toLowerCase();
  const mapAssign=new Map(cache.assigns.map(a=>[a.student_id,a.slot_id]));
  const cols=[{id:null,title:'ØºÙŠØ± Ù…ÙˆØ²Ù‘Ø¹',desc:'Ø·Ù„Ø§Ø¨ Ø¨Ù„Ø§ ÙˆÙ‚Øª Ù…Ø­Ø¯Ø¯',capacity:Infinity}];
  cache.slots.filter(sl => boardDayFilter==='all' || String(sl.weekday)===String(boardDayFilter))
    .forEach(sl=> cols.push({ id:sl.id, title:`${sl.title}  (#${sl.id})`, desc:`${wdName(sl.weekday)} â€¢ ${fmtHM(sl.start_time)}â€“${fmtHM(sl.end_time)} â€¢ Ø³Ø¹Ø© ${sl.capacity}`, capacity:sl.capacity }));

  const groups=new Map(cols.map(c=>[String(c.id),[]]));
  cache.students.forEach(s=>{
    if(q && !(s.name?.toLowerCase().includes(q) || (s.phone||'').includes(q))) return;
    const sid = mapAssign.get(s.id) ?? null; const key = groups.has(String(sid)) ? String(sid) : 'null';
    groups.get(key).push(s);
  });

  board.innerHTML='';
  cols.forEach(c=>{
    const g=groups.get(String(c.id))||[];
    const col=document.createElement('div'); col.className='rounded-xl bg-white/5 border border-white/10 p-3'; col.dataset.slotId=c.id??'';
    col.innerHTML=`
      <div class="flex items-center gap-2 mb-2">
        <div class="font-semibold">${c.title}</div>
        <div class="text-xs text-slate-400 mr-auto">${c.desc||''}</div>
        <span class="text-xs rounded-full px-2 py-0.5 bg-white/10 border border-white/10">${g.length}${isFinite(c.capacity)?'/'+c.capacity:''}</span>
        ${ c.id!==null ? `
          <button class="ml-2 px-2 py-1 text-xs rounded bg-indigo-500 hover:bg-indigo-400 text-white" data-col-remind="${c.id}">ğŸ””</button>
          <button class="px-2 py-1 text-xs rounded bg-sky-500 hover:bg-sky-400 text-white" data-col-edit="${c.id}">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="px-2 py-1 text-xs rounded bg-rose-500 hover:bg-rose-400 text-white" data-col-del="${c.id}">Ø­Ø°Ù</button>` : '' }
      </div>
      <div class="min-h-[80px] space-y-2" data-dropzone></div>`;
    const zone=col.querySelector('[data-dropzone]');
    g.forEach(s=>{
      const card=document.createElement('div'); card.className='glass rounded-lg px-3 py-2 cursor-move'; card.draggable=true; card.dataset.studentId=s.id;
      card.innerHTML=`<div class="font-medium">${s.name}</div><div class="text-xs text-slate-400">${s.phone||''}</div>`;
      card.addEventListener('dragstart', ev=>{ card.classList.add('dragging'); ev.dataTransfer.setData('text/plain', String(s.id)); });
      card.addEventListener('dragend', ()=> card.classList.remove('dragging')); zone.appendChild(card);
    });
    zone.addEventListener('dragover', ev=>{ ev.preventDefault(); col.classList.add('drop-ok'); });
    zone.addEventListener('dragleave', ()=> col.classList.remove('drop-ok'));
    zone.addEventListener('drop', async ev=>{ ev.preventDefault(); col.classList.remove('drop-ok'); const studentId=Number(ev.dataTransfer.getData('text/plain')); await assignStudent(studentId, c.id); });

    if(c.id!==null){
      col.querySelector('[data-col-edit]').onclick = ()=> handleEditSlot(Number(c.id));
      col.querySelector('[data-col-del]').onclick  = ()=> handleDeleteSlot(Number(c.id));
      col.querySelector('[data-col-remind]').onclick  = ()=> openReminder(Number(c.id));
    }
    board.appendChild(col);
  });
}

async function assignStudent(studentId, slotIdOrNull){
  const { data:{ user } } = await client.auth.getUser();

  if(slotIdOrNull==null){
    const { error } = await client.from('student_slots').delete().eq('student_id', studentId);
    if(error) return alert(error.message);
    toast('Ø£ÙØ²ÙŠÙ„ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©');
  } else {
    const slotId=Number(slotIdOrNull);
    const capRes = await client.from('slots').select('capacity').eq('id', slotId).maybeSingle();
    if (!capRes?.data) {
      alert('Ø§Ù„ÙˆÙ‚Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (Ø±Ø¨Ù…Ø§ Ø§Ù†Ø­Ø°Ù). Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ­Ø©.');
      await refreshBoard(); await refreshSlots();
      return;
    }
    const cap = capRes.data.capacity ?? 0;
    const occRes = await client.from('student_slots').select('id',{head:true,count:'exact'}).eq('slot_id', slotId);
    const occ = occRes.count ?? 0;

    if(occ >= cap){
      alert('Ø§Ù„Ø³Ø¹Ø© Ù…Ù…ØªÙ„Ø¦Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª. Ø§Ø®ØªØ± ÙˆÙ‚Øª Ø¢Ø®Ø±.');
      return;
    }
    const { error } = await client.from('student_slots').upsert([{ student_id: studentId, slot_id: slotId, created_by: user.id }], { onConflict:'student_id' });
    if(error) return alert(error.message); toast('Ù†ÙÙ‚Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨');
  }
  await refreshBoard(); await refreshSlots();
}

/* ===== Ø§Ù„Ø­Ø¶ÙˆØ± ===== */
const attDate = $('#att-date'), attSlot = $('#att-slot'), attBody = $('#att-body');
function jsWeekday(dateStr){ const [y,m,d]=dateStr.split('-').map(Number); const localNoon=new Date(y,m-1,d,12,0,0,0); return localNoon.getDay(); }
async function fillAttSlots(){
  attSlot.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙˆÙ‚Øª</option>'; if(!attDate.value) return;
  const wd = jsWeekday(attDate.value);
  const { data, error } = await client.from('slots').select('id,title,start_time,end_time').eq('weekday', wd).order('start_time');
  if (error){ attSlot.innerHTML = `<option value="">${error.message}</option>`; return; }
  if (!data?.length){ attSlot.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆÙ‚Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</option>'; return; }
  attSlot.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙˆÙ‚Øª</option>' + data.map(sl=>`<option value="${sl.id}">${sl.title} â€¢ ${fmtHM(sl.start_time)}â€“${fmtHM(sl.end_time)}</option>`).join('');
  if (data.length === 1) attSlot.value = String(data[0].id);
}
attDate.onchange = fillAttSlots;

/* ===== ØªØ°ÙƒÙŠØ± (ÙˆØ§ØªØ³Ø§Ø¨/SMS + ØªÙ†Ø¨ÙŠÙ‡ Ù…ØªØµÙØ­) ===== */
const remModal = $('#rem-modal'), remText = $('#rem-text'), remLinks = $('#rem-links');
const remTodayOnly = $('#rem-today-only'), remDayNote = $('#rem-day-note');
function closeRem(){ remModal.classList.remove('show'); }
$('#rem-close').onclick = closeRem;
$('#rem-close-bottom').onclick = closeRem;
$('#rem-x').onclick = closeRem;

$('#att-load').onclick = async ()=>{
  if(!attDate.value || !attSlot.value){ return alert('Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª'); }
  const slot_id = Number(attSlot.value);
  const { data: ss } = await client.from('student_slots').select('student_id').eq('slot_id', slot_id);
  const ids = (ss||[]).map(x=>x.student_id);
  if(!ids.length){ attBody.innerHTML = `<tr><td class="px-4 py-4 text-slate-400" colspan="4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª</td></tr>`; return; }

  const { data: students } = await client.from('students').select('id,name,phone').in('id', ids).order('name');
  const { data: curr } = await client.from('attendance').select('student_id,status,note').eq('slot_id', slot_id).eq('day', attDate.value);
  const currMap = new Map((curr||[]).map(a=>[a.student_id, {status:a.status, note:a.note}]));

  attBody.innerHTML = '';
  (students||[]).forEach(s=>{
    const st = currMap.get(s.id)?.status || 'present';
    const note = currMap.get(s.id)?.note || '';
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="px-4 py-3 border-b border-white/10 font-medium">${s.name}</td>
      <td class="px-4 py-3 border-b border-white/10 text-slate-300">${s.phone||''}</td>
      <td class="px-4 py-3 border-b border-white/10">
        <select class="rounded-lg bg-white/5 border border-white/10 px-2 py-1" data-st="${s.id}">
          <option value="present" ${st==='present'?'selected':''}>Ø­Ø§Ø¶Ø±</option>
          <option value="absent" ${st==='absent'?'selected':''}>ØºØ§ÙŠØ¨</option>
          <option value="excused" ${st==='excused'?'selected':''}>Ù…Ø¹Ø°ÙˆØ±</option>
        </select>
      </td>
      <td class="px-4 py-3 border-b border-white/10"><input class="w-full rounded-lg bg-white/5 border border-white/10 px-2 py-1" data-note="${s.id}" value="${note||''}"></td>
    `;
    attBody.appendChild(tr);
  });
};

$('#att-save').onclick = async ()=>{
  if(!attDate.value || !attSlot.value){ return alert('Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª'); }
  const slot_id = Number(attSlot.value), day = attDate.value;
  const rows=[];
  attBody.querySelectorAll('select[data-st]').forEach(sel=>{
    const student_id = Number(sel.getAttribute('data-st'));
    const status = sel.value;
    const note = attBody.querySelector(`input[data-note="${student_id}"]`)?.value || null;
    rows.push({ slot_id, student_id, day, status, note });
  });
  if(!rows.length) return;
  const { data:{ user } } = await client.auth.getUser();
  rows.forEach(r=> r.created_by = user.id);
  const { error } = await client.from('attendance').upsert(rows, { onConflict:'slot_id,student_id,day' });
  if (error) return alert(error.message);
  toast('Ø§Ù†Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±');
};

function buildReminderText(sl){
  const next = nextDateForWeekday(sl.weekday);
  const d = next.toLocaleDateString('ar-IQ', { weekday:'long', year:'numeric', month:'numeric', day:'numeric' });
  return `ØªØ°ÙƒÙŠØ± Ø¨Ù…Ø­Ø§Ø¶Ø±Ø© ${sl.title} ÙŠÙˆÙ… ${d} Ø§Ù„Ø³Ø§Ø¹Ø© ${fmtHM(sl.start_time)} â€“ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„ÙˆÙ‚Øª.`;
}
function openReminder(slotId){
  const sl = cache.slots.find(s=>s.id===slotId);
  if(!sl){ alert('Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
  // Ø§Ø­ÙØ¸ Ø§Ù„Ù€ slotId Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
  remModal.dataset.slotId = String(slotId);

  const students = cache.assigns
    .filter(a=>a.slot_id===slotId)
    .map(a=> cache.students.find(s=>s.id===a.student_id))
    .filter(Boolean);

  remText.value = buildReminderText(sl);

  // Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ÙŠÙˆÙ…/Ù„ÙŠØ³ Ø§Ù„ÙŠÙˆÙ…
  const isToday = (new Date().getDay() === sl.weekday);
  remDayNote.textContent = isToday
    ? `Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª Ù‡Ùˆ Ø§Ù„ÙŠÙˆÙ… (${wdName(sl.weekday)}).`
    : `Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª Ù„ÙŠØ³ Ø§Ù„ÙŠÙˆÙ… (${wdName(sl.weekday)}). Ø®ÙŠØ§Ø± "Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·" Ø³ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.`;

  // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· â€” Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª ÙÙ‚Ø· + Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø©
  remLinks.innerHTML='';
  students.forEach(st=>{
    const ph = normalizeIQ(st.phone||'');
    if(!ph) return; // ØªØ¬Ø§Ù‡Ù„ Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…
    const wa = `https://wa.me/${ph}?text=${encodeURIComponent(remText.value)}`;
    const sms = `sms:${ph}?&body=${encodeURIComponent(remText.value)}`;
    const row = document.createElement('div');
    row.className='flex items-center gap-2 text-sm';
    row.innerHTML = `<span class="text-slate-300 mr-auto">${st.name} â€” ${st.phone||''}</span>
      <a data-wa href="${wa}" target="_blank" class="px-2 py-1 rounded bg-sky-600/80 hover:bg-sky-500 text-white">ÙˆØ§ØªØ³Ø§Ø¨</a>
      <a href="${sms}" class="px-2 py-1 rounded bg-emerald-600/80 hover:bg-emerald-500 text-white">SMS</a>`;
    remLinks.appendChild(row);
  });

  remModal.classList.add('show');
}

$('#rem-copy').onclick = ()=> { remText.select(); document.execCommand('copy'); toast('Ø§Ù†Ù†Ø³Ø® Ø§Ù„Ù†Øµ'); };
$('#rem-open-all-wa').onclick = ()=> {
  const links = Array.from(remLinks.querySelectorAll('a[data-wa]'));
  if(!links.length) return alert('Ù„Ø§ Ø±ÙˆØ§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ Ù…ØªØ§Ø­Ø© (ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£Ø±Ù‚Ø§Ù…).');

  // ÙÙ„ØªØ± "Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·"
  const slotId = Number(remModal.dataset.slotId || 0);
  const sl = cache.slots.find(s=>s.id===slotId);
  if (!sl) return alert('Ø§Ù„ÙˆÙ‚Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.');
  if (remTodayOnly.checked && (new Date().getDay() !== sl.weekday)) {
    alert('Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª Ù„ÙŠØ³ Ø§Ù„ÙŠÙˆÙ… Ùˆ"Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·" Ù…ÙØ¹Ù‘Ù„ â€” Ù„Ù† ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.');
    return;
  }

  // ÙØªØ­ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¨Ø§Ù„ØªØ¯Ø±ÙŠØ¬
  links.forEach((a,i)=> setTimeout(()=>window.open(a.href,'_blank'), i*300));
};

/* ===== ØªÙˆØ²ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø±) ===== */
const autoBtn = document.getElementById('auto-distribute');
autoBtn.onclick = autoDistribute;

async function autoDistribute(){
  autoBtn.disabled = true;
  try{
    await loadBoardData();
    const slots = cache.slots.filter(s => boardDayFilter==='all' || String(s.weekday)===String(boardDayFilter));
    if (!slots.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆÙ‚Ø§Øª Ø¶Ù…Ù† Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ');

    const assignedSet = new Set(cache.assigns.map(a=>a.student_id));
    const unassigned = cache.students.filter(s=>!assignedSet.has(s.id));
    if (!unassigned.length) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ²Ø¹ÙŠÙ†');

    const occBySlot = new Map();
    cache.assigns.forEach(a => occBySlot.set(a.slot_id, (occBySlot.get(a.slot_id)||0)+1));
    const buckets = slots.map(s => ({ slot_id: s.id, left: Math.max(0, s.capacity - (occBySlot.get(s.id)||0)) }))
                         .filter(b => b.left > 0);
    if (!buckets.length) return alert('ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ù…Ù…ØªÙ„Ø¦Ø©ØŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø§Ø¹Ø¯ Ø´Ø§ØºØ±Ø©');

    if(!confirm(`Ø³ÙŠØªÙ… ØªÙˆØ²ÙŠØ¹ ${unassigned.length} Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù‰ ${slots.length} ÙˆÙ‚Øª${boardDayFilter!=='all'?' (Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·)':''}. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) return;

    const { data:{ user } } = await client.auth.getUser();
    const rows = [];
    let idx = 0;

    while (idx < unassigned.length && buckets.some(b => b.left > 0)) {
      for (let i = 0; i < buckets.length && idx < unassigned.length; i++) {
        if (buckets[i].left > 0) {
          rows.push({ student_id: unassigned[idx].id, slot_id: buckets[i].slot_id, created_by: user.id });
          buckets[i].left--;
          idx++;
        }
      }
    }

    if (rows.length) {
      const { error } = await client.from('student_slots').upsert(rows, { onConflict: 'student_id' });
      if (error) return alert(error.message);
    }

    const leftover = unassigned.length - rows.length;
    toast(`ØªÙ… ØªÙˆØ²ÙŠØ¹ ${rows.length} Ø·Ø§Ù„Ø¨${leftover>0?` â€” ${leftover} Ø¨Ø¯ÙˆÙ† Ù…ÙƒØ§Ù† (ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ù…Ù…ØªÙ„Ø¦Ø©)`:''}`);
    await refreshBoard();
    await refreshSlots();
  } finally {
    autoBtn.disabled = false;
  }
}

/* ===== Realtime ===== */
let rtCh=null;
function unsubscribeRT(){ if(rtCh){ client.removeChannel(rtCh); rtCh=null; } }
async function subscribeRT() {
  unsubscribeRT();
  await ensureRealtimeAuth();
  rtCh = client
    .channel('sched', { config: { broadcast: { ack: true } } })
    .on('postgres_changes', { event:'*', schema:'public', table:'students'      }, async ()=>{ await loadStudents($('#qStudents').value); await refreshBoard(); })
    .on('postgres_changes', { event:'*', schema:'public', table:'slots'         }, async ()=>{ await refreshSlots(); await refreshBoard(); })
    .on('postgres_changes', { event:'*', schema:'public', table:'student_slots' }, async ()=>{ await refreshSlots(); await refreshBoard(); })
    .on('postgres_changes', { event:'*', schema:'public', table:'payments'      }, async ()=>{ await loadStudents($('#qStudents').value); })
    .subscribe((status) => {
      console.log('Realtime status:', status);
      if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT' || status === 'CLOSED') {
        setTimeout(subscribeRT, 1200);
      }
    });
  window.addEventListener('online', subscribeRT, { once:true });
}

/* ===== Ø¨Ù†Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ­Ø§Øª ===== */
async function refreshBoard(){ await loadBoardData(); renderBoard($('#qBoard').value); }

/* ===== ØªØ´ØºÙŠÙ„ ===== */
(function initDefaults(){
  const dt = new Date();
  const iso = new Date(dt.getTime()-dt.getTimezoneOffset()*60000).toISOString().slice(0,10);
  $('#att-date').value = iso;
})();
(async ()=>{
  const u = await guard(); if(!u) return;
  await ensureRealtimeAuth();
  await Promise.all([ loadStudents(), refreshSlots(), refreshBoard(), fillAttSlots() ]);
  await subscribeRT();
  if('Notification' in window && Notification.permission==='granted'){ scheduleLocalNotifsForToday(); }
})();
</script>
<!-- Ø²Ø± ØªØ«Ø¨ÙŠØª PWA -->
<button id="pwa-install"
  style="position:fixed;bottom:84px;left:50%;transform:translateX(-50%);
         background:#10b981;color:#fff;border:0;border-radius:999px;
         padding:10px 16px;font-weight:600;box-shadow:0 10px 25px rgba(16,185,129,.35);
         display:none;z-index:70;">
  Ø«Ø¨Ù‘Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
</button>

<!-- ØªÙ†Ø¨ÙŠÙ‡ iOS Ù„Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ÙŠØ¯ÙˆÙŠ -->
<div id="ios-a2hs"
     style="position:fixed;bottom:84px;left:50%;transform:translateX(-50%);
            background:#111827;color:#e5e7eb;border:1px solid #1f2937;border-radius:12px;
            padding:10px 12px;font-size:13px;display:none;z-index:69;">
  Ø¹Ù„Ù‰ iPhone: Ø§ÙØªØ­ <b>Share</b> â†’ Ø§Ø®ØªØ± <b>Add to Home Screen</b>
  <button id="ios-a2hs-close"
          style="margin-right:10px;background:transparent;border:0;color:#9ca3af;">Ø¥Ø®ÙØ§Ø¡</button>
</div>

<script>
  // Ù…Ù†Ø·Ù‚ Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª
  let deferredPrompt = null;
  const btn = document.getElementById('pwa-install');
  const iosHint = document.getElementById('ios-a2hs');
  const iosClose = document.getElementById('ios-a2hs-close');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    btn.style.display = 'inline-block';
  });

  btn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const choice = await deferredPrompt.userChoice;
    deferredPrompt = null;
    btn.style.display = 'none';
    // Ù„Ùˆ ØªØ±ÙŠØ¯ ØªØªØ¨Ø¹ outcome: choice.outcome === 'accepted' | 'dismissed'
  });

  window.addEventListener('appinstalled', () => {
    btn.style.display = 'none';
  });

  // iOS (Ù…Ø§ÙƒÙˆ beforeinstallprompt) â€” Ø¹Ø±Ø¶ ØªÙ„Ù…ÙŠØ­ ÙŠØ¯ÙˆÙŠ
  const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || (navigator.standalone === true);
  if (isIos && !isStandalone) {
    setTimeout(() => { iosHint.style.display = 'block'; }, 1200);
  }
  iosClose.onclick = () => iosHint.style.display = 'none';
</script>

</body>
</html>
